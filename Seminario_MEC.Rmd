---
title: "Seminario_MEC"
author: "César Tejido, Elena Ruiz, Marina Martin"
date: "`r Sys.Date()`"
output: html_document
---

```{r, echo = FALSE}
library(readr)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(forcats)
library(hrbrthemes)
library(viridis)
library(rjson)
library(XML)
library(tidyjson)
library(tidyr)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduccion

La salud mental en España es cada vez más preocupante, se ha disparado el número de jóvenes que ha tenido problemas de salud mental. En 2017 el primer Barómetro registraba un 28,4% de jóvenes con problemas de salud mental y en 2023 llega al 59,3%. 
```{r}
# Crear un data frame con los datos
datos_salud_mental <- data.frame(
  Año = c(2017, 2023),
  Porcentaje = c(28.4, 59.3)
)

# Crear el gráfico de barras
grafico <- ggplot(datos_salud_mental, aes(x = factor(Año), y = Porcentaje, fill = factor(Año))) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(title = "Problemas de Salud Mental en Jóvenes (2017-2023)",
       x = "Año",
       y = "Porcentaje") +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62")) +  # Colores personalizados
  theme_minimal()

# Mostrar el gráfico
print(grafico)
```

La brecha de género también existe en salud mental. Hay más hombres que mujeres que nunca han experimentado trastornos (42,4%, frente al 30,9% de ellas).
```{r}
# Crear un data frame con los datos
datos_salud_mental_genero <- data.frame(
  Genero = c("Hombres", "Mujeres"),
  Porcentaje = c(42.4, 30.9)
)

# Crear el gráfico de barras apiladas
grafico_genero <- ggplot(datos_salud_mental_genero, aes(x = factor(Genero), y = Porcentaje, fill = factor(Genero))) +
  geom_bar(stat = "identity", width = 0.7) +
  labs(title = "Brecha de Género en Salud Mental",
       x = "Género",
       y = "Porcentaje") +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62")) +  # Colores personalizados
  theme_minimal()

# Mostrar el gráfico
print(grafico_genero)

```

Los datos no son positivos de por sí, pero son aún peores cuando los cruzamos con variables socioeconómicas y corroboramos que la vulnerabilidad frente a enfermedades y trastornos mentales está relacionada con las carencias materiales que se tienen, y también las posibilidades de reducir esa vulnerabilidad.

Los datos de este barómetro en 2023 también evidencian el incremento en la ideación suicida. 1 de cada 4 jóvenes ha experimentado alguna vez ideas suicidas (23,8%), un 11,3% piensa en el suicidio con cierta frecuencia y el 13,8% experimenta ideas de suicidio con mucha frecuencia o continuamente.

```{r}
# Crear un data frame con los datos
datos_ideacion_suicida <- data.frame(
  Categoria = c("Nunca", "Con cierta frecuencia", "Con mucha frecuencia o continuamente"),
  Porcentaje = c(23.8, 11.3, 13.8)
)

# Crear el diagrama de tarta
grafico_ideacion_suicida <- ggplot(datos_ideacion_suicida, aes(x = "", y = Porcentaje, fill = Categoria)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  labs(title = "Ideación Suicida en Jóvenes (2023)",
       fill = "Frecuencia",
       x = NULL,
       y = NULL) +
  theme_minimal() +
  theme(legend.position = "bottom")  # Mover la leyenda a la parte inferior

# Mostrar el diagrama de tarta
print(grafico_ideacion_suicida)

```


Por todo ello, hemos creido conveniente estudiar el caso. Esta vez vamos a cruzar los datos de las enfermedades mentales más frecuentes en nuestro país (depresión y ansiedad) con el PIB de cada comunidad autónoma y el sendentarismo, ya que creemos que pueden tener relación directa. Ya que aquellas comunidades autónomas que tengan un PIB más alto, permitiran que sus provincias puedan tener un mayor acceso a actividades cotidianas que ayudan a las personas a caer en menor medida en este tipo de transtornos.

# Objetivos

- Averiguar si existe relación entre el PIB con los datos sobre enfermedades mentales en España y estudiar si en aquellas comunidades autónomas en las que el PIB sea más bajo tienen influencia sobre la tasa de suicidio de estas.
- Estudiar la relación entre la tasa de sedentarismo y las enfermedades mentales por comunidad autónoma.
- Realizar un estudio general con todas las variables para encontrar una posible relación con la tasa de suicidio.

#Datos
Los archivos escogidos pertenecen a dos fuentes de datos: el Instituto Nacional de Estadística (INE) y la página oficial del Gobierno de España (gob.es)
El formato de datos escogido son tanto .csv como .json.

URLs:
- PIB por CCAA --> "https://www.ine.es/jaxiT3/Datos.htm?t=45599" (Json)
- Enfermedades Mentales por CCAA --> "https://www.ine.es/jaxiT3/Datos.htm?tpx=51400" (Json)
- Tasa de suicidio por CCAA --> "https://www.ine.es/jaxiT3/Datos.htm?tpx=46688" (Json)
- Depresión por CCAA --> "https://datos.gob.es/es/catalogo/ea0010587-prevalencia-de-cuadros-depresivos-activos-segun-sexo-y-comunidad-autonoma-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p04-l0-13010-px1" (Json)



##Importación

1º CONJUNTO DE DATOS
Depresión por CCAA
```{r}
DepresionCCAA <- fromJSON(file = "Data/DepresionCCAA.json")
#DepresionCCAA
```

```{r}
DepresionCCAAcsv <- read_delim("Data/DepresionCCAA.csv", delim = ";", show_col_types = FALSE)
DepresionCCAAcsv
```

```{r}
depresionCCAA <- spread_all(DepresionCCAA)
#View(depresionCCAA)
```

```{r}
Depresion <- depresionCCAA %>%
  separate(Nombre, into = c("Sexo", "Comunidad", "Prevalencia"), sep = ",") %>%
  select(document.id,Sexo,Comunidad,Prevalencia)

Depresion
```

```{r}
depresionCCAA %>% 
  gather_object %>% 
  json_types %>% 
  count(name, type)
```

```{r}
dataD <- DepresionCCAA %>%
  enter_object(Data) %>%
  gather_array %>%
  spread_all %>%   #para que lo reconozca y lo ponga como columnas(lo separa)
  select(document.id, Valor)
dataD
```

```{r}
#no necesario
meta <- DepresionCCAA %>%
  enter_object(MetaData) %>%
  gather_array %>%
  spread_all
```

```{r}
# Union tablas de depresion
union_depresion <- full_join(dataD,Depresion,by="document.id")
union_depresion
```


2º CONJUNTO DE DATOS
Enfermedades Mentales por CCAA
```{r}
EnfermedadesMentales <- fromJSON(file = "Data/EnfermedadesMentales.json")

```

```{r}
#EnfermedadesMentales.csv <- read_delim("Data/EnfermedadesMentales.csv", delim = ";", show_col_types = FALSE)
#EnfermedadesMentales.csv
```

```{r}
enfermedadesMentales <- spread_all(EnfermedadesMentales)
enfermedadesMentales
```
```{r}
EnfMentales <- enfermedadesMentales %>%
  separate(Nombre, into = c("Comunidad","Sexo","Enfermedad"), sep = ",") %>%
  select(document.id,Comunidad,Sexo,Enfermedad)

EnfMentales
```


```{r}
enfermedadesMentales %>% 
  gather_object %>% 
  json_types %>% 
  count(name, type)
```

```{r}
dataM <- EnfermedadesMentales %>%
  enter_object(Data) %>%
  gather_array %>%
  spread_all %>%   #para que lo reconozca y lo ponga como columnas(lo separa)
  select(document.id, Valor)
dataM
```


```{r}
#NOoo
metaM <- EnfermedadesMentales %>%
  enter_object(MetaData) %>%
  gather_array %>%
  spread_all
metaM
```

```{r}
union_enfMentales <- full_join(dataM,EnfMentales,by="document.id")
union_enfMentales
```



3º CONJUNTO DE DATOS
PIB por CCAA
```{r}
PIB <- fromJSON(file = "Data/PIB.json")
#PIB
```

```{r}
#PIB.csv <- read_delim(file = "Data/PIB.csv", delim = ";", show_col_types = FALSE)
#PIB.csv
#str(PIB)
```

```{r}
pib <- spread_all(PIB)
pib
```


```{r}
PIb <- pib %>%
  separate(Nombre, into = c("Comunidad","DB","Tasa de crecimiento"), sep = ".") %>%
  select(document.id,Comunidad)
PIb
```

```{r}
pib %>% 
  gather_object %>% 
  json_types %>% 
  count(name, type)
```

```{r, echo = FALSE}
dataP <- pib %>%
  enter_object(Data) %>%
  gather_array %>%
  spread_all #%>%   #para que lo reconozca y lo ponga como columnas(lo separa)
  #select(document.id, Valor)
#dataP
```

```{r}
MetaP <- pib %>%
  enter_object(MetaData) %>%
  gather_array %>%
  spread_all #%>%   #para que lo reconozca y lo ponga como columnas(lo separa)
  #select(document.id, Valor)
MetaP
```
```{r}
union_pib <- full_join(dataP,PIb,by="document.id")
union_pib
```



4º CONJUNTO DE DATOS
```{r}
Suicidio <- fromJSON(file = "Data/Suicidio.json")
#Suicidio
```

```{r}
#Suicidio.csv <- read_delim("Data/Suicidio.csv", delim = ";", show_col_types = FALSE)
#Suicidio.csv
```

```{r}
suicidio <- spread_all(Suicidio)
```


```{r}
TasaSuicidio <- suicidio %>%
  separate(Nombre, into = c("Comunidad", "Edad", "Sexo"), sep = ",") %>%
  select(document.id,Comunidad,Edad,Sexo)
TasaSuicidio
```


```{r}
suicidio %>% 
  gather_object %>% 
  json_types %>% 
  count(name, type)
```

```{r}
data <- Suicidio %>%
  enter_object(Data) %>%
  gather_array %>%
  spread_all %>%   #para que lo reconozca y lo ponga como columnas(lo separa)
  select(document.id,NombrePeriodo,Valor)
#s <- select(.data = data,c(document.id,NombrePeriodo,Valor))
#s
```

```{r}
# TABLA FINAL SUICIDIO
union_suicidio <- full_join(data,TasaSuicidio, by="document.id")
union_suicidio

```
En data no hay nada util
# El valor es el tanto por cien mil


```{r}
meta <- Suicidio %>%
  enter_object(MetaData) %>%
  gather_array %>%
  spread_all
```

Union data y TSuicido
```{r}
s <- full_join(data,TasaSuicidio,by="document.id")
s
```

UNION DEPRESIÓN Y SUICIDIO
```{r}
#depr_y_suicidio <- full_join(union_depresion, union_suicidio, by = "Comunidad")
#depr_y_suicidio
```























